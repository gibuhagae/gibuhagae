<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gibuhagae.gibuhagae.order.dao.OrderMapper">

    <resultMap id="generalOrderListResultMap" type="com.gibuhagae.gibuhagae.order.dto.OrderManagementDTO">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="orderDate" column="ORDER_DATE"/>
        <result property="orderStatus" column="ORDER_STATUS"/>
        <result property="orderCount" column="ORDER_COUNT"/>
        <result property="donateYN" column="DONATE_YN"/>
        <result property="paymentPrice" column="PAYMENT_PRICE"/>
        <result property="cancelDate" column="CANCEL_DATE"/>
        <result property="cerStatus" column="CER_STATUS"/>
        <result property="totalOrderPrice" column="TOTAL_ORDER_PRICE"/>
        <result property="donatePrice" column="DONATE_PRICE"/>
        <result property="recipientName" column="RECIPIENT_NAME"/>
        <result property="itemName" column="ITEM_NAME"/>
        <result property="optionName" column="OPTION_NAME"/>
        <result property="registrationNo" column="REGISTRATION_NO"/>
        <result property="postOffice" column="POSTOFFICE"/>
        <result property="deliveryRequest" column="DELIVERY_REQUEST"/>
    </resultMap>

    <resultMap id="memberResultMap" type="com.gibuhagae.gibuhagae.member.dto.MemberDTO">
        <id property="memberNo" column="MEMBER_NO"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberPhone" column="MEMBER_PHONE"/>
        <result property="zipCode" column="ZIPCODE"/>
        <result property="address" column="ADDRESS"/>
        <result property="registDate" column="REGIST_DATE"/>
        <result property="updateDate" column="UPDATE_DATE"/>
        <result property="email" column="EMAIL"/>
        <result property="donatePrice" column="DONATE_PRICE"/>
        <result property="password" column="PASSWORD"/>
        <result property="userId" column="USER_ID"/>
        <result property="userCode" column="USER_CODE"/>
        <result property="loginType" column="LOGIN_TYPE"/>
        <result property="activation_status" column="ACTIVATION_STATUS"/>

    </resultMap>

    <resultMap id="postResultMap" type="com.gibuhagae.gibuhagae.order.dto.PostDTO">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="recipientName" column="RECIPIENT_NAME"/>
        <result property="recipientPhone" column="RECIPIENT_PHONE"/>
        <result property="zipCode" column="ZIPCODE"/>
        <result property="address" column="ADDRESS"/>
        <result property="registrationDate" column="REGISTRATION_DATE"/>
        <result property="deliveryRequest" column="DELIVERY_REQUEST"/>
        <result property="registrationNo" column="REGISTRATION_NO"/>
        <result property="postOffice" column="POSTOFFICE"/>
    </resultMap>

    <resultMap id="itemResultMap" type="com.gibuhagae.gibuhagae.productManagement.dto.ItemDTO">
        <id property="itemCode" column="ITEM_CODE"/>
        <result property="itemName" column="ITEM_NAME"/>
        <result property="saleStatus" column="SALE_STATUS"/>
        <result property="registDate" column="REGIST_DATE"/>
        <result property="categoryCode" column="CATEGORY_CODE"/>
        <result property="totalCount" column="TOTAL_COUNT"/>
    </resultMap>

    <resultMap id="itemOptionMap" type="com.gibuhagae.gibuhagae.productManagement.dto.ItemOptionDTO">
        <id property="optionCode" column="OPTION_CODE"/>
        <id property="itemCode" column="ITEM_CODE"/>
        <result property="optionName" column="OPTION_NAME"/>
        <result property="registDate" column="REGIST_DATE"/>
        <result property="salePrice" column="SALE_PRICE"/>
        <result property="count" column="COUNT"/>
    </resultMap>

    <!-- summary 혁 2023-10-18 START-->
    <resultMap id="orderDetailDTO" type="com.gibuhagae.gibuhagae.order.dto.OrderDetailDTO">
        <id property="orderDetailCode" column="ORDER_DETAIL_CODE"/>
        <result property="itemCode" column="ITEM_CODE"/>
        <result property="optionCode" column="OPTION_CODE"/>
        <result property="orderNo" column="ORDER_NO"/>
        <result property="count" column="COUNT"/>
        <result property="price" column="PRICE"/>
    </resultMap>

    <select id="selectOrderDetailPK" resultType="int">
        SELECT
            ORDER_DETAIL_CODE
        FROM
            ORDER_DETAIL
        WHERE
            ORDER_NO = #{orderManageCode}
    </select>

    <!-- summary 혁 2023-10-18 END-->

    <select id="selectNewOrderList" resultMap="generalOrderListResultMap">
        SELECT
            OM.ORDER_NO,
            OM.ORDER_DATE,
            P.RECIPIENT_NAME,
            I.ITEM_NAME,
            IO.OPTION_NAME,
            OM.PAYMENT_PRICE,
            OM.ORDER_COUNT,
            P.DELIVERY_REQUEST,
            OM.ORDER_STATUS
        FROM ORDER_MANAGEMENT OM
                 JOIN POST P ON OM.ORDER_NO = P.ORDER_NO
                 JOIN ORDER_DETAIL OD ON OM.ORDER_NO = OD.ORDER_NO
                 JOIN ITEM I ON OD.ITEM_CODE = I.ITEM_CODE
                 JOIN ITEM_OPTION IO ON OD.OPTION_CODE = IO.OPTION_CODE
--         WHERE ORDER_STATUS = '신규주문'
        ORDER BY OM.ORDER_NO ASC
    </select>

    <update id="updatePost" parameterType="com.gibuhagae.gibuhagae.order.dto.OrderManagementDTO">
        UPDATE POST
        SET
            REGISTRATION_NO = #{ trackingNumber },
            POSTOFFICE = #{ deliveryCompany }
        WHERE ORDER_NO = #{ selectedOrderNo }
    </update>

    <update id="modifyOrderDetailStatus" parameterType="com.gibuhagae.gibuhagae.order.dto.OrderManagementDTO">
        UPDATE
            ORDER_MANAGEMENT
        SET
            ORDER_STATUS = #{orderStatus}
        WHERE
            ORDER_NO = #{orderManageNo}
    </update>

<!--    summary 혁 2023-10-19-->
    <insert id="insertRefundManagement">
        INSERT
        INTO REFUND_MANAGEMENT (
            REFUND_NUMBER,
            REFUND_REASON,
            ORDER_DETAIL_CODE
        )
        VALUES (
            SEQ_REFUND_NO.NEXTVAL,
                #{ reasonText },
                #{ orderDetailCode }
        )
    </insert>

    <insert id="insertSwapManagement">
        INSERT
        INTO SWAP_MANAGEMENT (
            SWAP_NUMBER,
            SWAP_REASON,
            ORDER_DETAIL_CODE
        )
        VALUES (
            SEQ_SWAP_NO.NEXTVAL,
            #{ reasonText },
            #{ orderDetailCode }
        )
    </insert>

</mapper>